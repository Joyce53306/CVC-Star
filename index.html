<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CVC Star Hero ğŸš€</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Andika&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CVC Hero">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5402/5402751.png">

    <style>
        :root { --pink: #f8a5c2; --blue: #778beb; --bg: #fffbe6; --gold: #feca57; --accent: #54a0ff; --green: #b2ff59; }
        * { -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        
        body { 
            /* 2. å…¨åŸŸå¥—ç”¨ Andika å­—é«” */
            font-family: 'Andika', sans-serif; 
            background-color: var(--bg); 
            text-align: center; 
            margin: 0; 
            padding: 10px; 
            /* ç¢ºä¿ iOS å½ˆæ€§æ»¾å‹•é«”é©— */
            -webkit-overflow-scrolling: touch;
        }
        
        .container { max-width: 600px; margin: auto; padding: 20px; background: white; border-radius: 40px; box-shadow: 0 15px 0 #f0e68c; min-height: 95vh; position: relative; display: flex; flex-direction: column; }
        .header { color: var(--accent); font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .stars { font-size: 40px; color: var(--gold); min-height: 50px; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        
        /* ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•éƒ½ç¹¼æ‰¿ Andika å­—é«” */
        button { font-family: 'Andika', sans-serif; }

        .btn-vowel { padding: 25px 10px; background: var(--pink); color: white; border-radius: 20px; font-size: 45px; cursor: pointer; border: none; box-shadow: 0 5px #f681a2; }
        .btn-family { padding: 15px 5px; background: #e3f2fd; color: #1976D2; border-radius: 15px; font-size: 26px; cursor: pointer; border: 1px solid #bbdefb; box-shadow: 0 4px #90caf9; }

        .word-pic { font-size: 80px; margin: 20px 0; }
        .choice-container { display: flex; justify-content: space-around; margin: 25px 0; }
        
        .circle-btn { 
            width: 140px; 
            height: 140px; 
            border-radius: 50%; 
            border: 8px solid white; 
            font-size: 38px; 
            color: white; 
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 8px 0 rgba(0,0,0,0.1); 
        }
        .pink { background-color: var(--pink); }
        .blue { background-color: #bbdefb; color: #1565c0 !important; }

        .rec-box { background: #fdfdfd; border: 2px solid #eee; border-radius: 30px; padding: 15px; margin-top: 15px; }
        .rec-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: #ff5252; color: white; font-size: 24px; cursor: pointer; }
        .play-btn { width: 100%; background: var(--green); border: none; padding: 12px; border-radius: 20px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        .home-btn { 
            background: #eee; 
            color: #666; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 20px; 
            font-size: 18px; 
            margin-top: auto; 
            cursor: pointer; 
            display: inline-block;
            align-self: center;
        }

        .hidden { display: none !important; }
        .victory-jump { animation: jump 0.5s ease infinite alternate; }
        @keyframes jump { from { transform: translateY(0); } to { transform: translateY(-10px); } }
    </style>
</head>
<body>

<div class="container">
    <div id="view-vowels">
        <h2 class="header">CVC Star Hero ğŸš€</h2>
        <div class="stars">âœ¨âœ¨âœ¨</div>
        <p>Pick a Sound!</p>
        <div class="grid">
            <button class="btn-vowel" onclick="unlockAudio(); showFamilies('a')">a</button>
            <button class="btn-vowel" onclick="unlockAudio(); showFamilies('e')" style="background: #4db6ac; box-shadow: 0 5px #00897b;">e</button>
            <button class="btn-vowel" onclick="unlockAudio(); showFamilies('i')" style="background: #7986cb; box-shadow: 0 5px #5c6bc0;">i</button>
            <button class="btn-vowel" onclick="unlockAudio(); showFamilies('o')" style="background: #ffb74d; box-shadow: 0 5px #fb8c00;">o</button>
            <button class="btn-vowel" onclick="unlockAudio(); showFamilies('u')" style="background: #ba68c8; box-shadow: 0 5px #8e24aa;">u</button>
        </div>
    </div>

    <div id="view-families" class="hidden">
        <h2 class="header" id="family-title">Word Families</h2>
        <div class="grid" id="family-list"></div>
        <button class="home-btn" onclick="goHome()" style="margin-top: 30px;">ğŸ  Home</button>
    </div>

    <div id="view-game" class="hidden">
        <div class="header" id="game-title">-at Family</div>
        <div class="stars" id="star-display">â˜†â˜†â˜†â˜†â˜†</div>
        <div class="word-pic" id="word-emoji">ğŸ±</div>
        
        <div id="question-area">
            <div class="choice-container">
                <button id="opt1" class="circle-btn pink" onclick="checkAnswer(this)"></button>
                <button id="opt2" class="circle-btn blue" onclick="checkAnswer(this)"></button>
            </div>
        </div>

        <div id="feedback-area" class="hidden">
            <div class="rec-box">
                <button id="recBtn" class="rec-btn" onclick="toggleRecording()">ğŸ¤</button>
                <p id="rec-hint" style="font-size:12px; color:gray;">é»ä¸€ä¸‹éŒ„éŸ³</p>
                <button id="playRecBtn" class="play-btn hidden" onclick="playBack()">â–¶ï¸ è½æˆ‘çš„è²éŸ³</button>
            </div>
            <button class="play-btn" style="background:var(--accent); color:white; margin-top:15px;" onclick="nextRound()">NEXT â”</button>
        </div>
        
        <button class="home-btn" onclick="goHome()">ğŸ  Home</button>
    </div>
</div>

<script>
    // ----- 1. éŸ³æ•ˆè§£é– (è§£æ±º iOS ç¦æ­¢è‡ªå‹•æ’­æ”¾è²éŸ³çš„å•é¡Œ) -----
    const victoryAudio = new Audio('https://www.myinstants.com/media/sounds/final-fantasy-vii-victory-fanfare-1.mp3');
    victoryAudio.preload = 'auto';

    function stopVictoryMusic() {
        victoryAudio.pause();
        victoryAudio.currentTime = 0;
    }

    // ç•¶ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡é»æ“ŠæŒ‰éˆ•æ™‚ï¼Œæ’­æ”¾æ¥µçŸ­æš«çš„è²éŸ³ä¾†ã€Œè§£é–ã€ç€è¦½å™¨çš„éŸ³æ•ˆåŠŸèƒ½
    function unlockAudio() {
        victoryAudio.play().then(() => { stopVictoryMusic(); }).catch(() => {});
    }

    function goHome() {
        stopVictoryMusic();
        location.reload();
    }

    // ----- 2. å–®å­—è³‡æ–™åº« -----
    const cvcData = {
        'a': {
            'at': { emoji: 'ğŸ±', words: ['cat', 'bat', 'hat', 'mat', 'rat'] },
            'ad': { emoji: 'ğŸ§”', words: ['dad', 'sad', 'mad', 'bad', 'pad'] },
            'an': { emoji: 'ğŸš', words: ['van', 'pan', 'can', 'fan', 'man'] },
            'am': { emoji: 'ğŸ', words: ['jam', 'ham', 'ram', 'yam'] },
            'ap': { emoji: 'ğŸ—ºï¸', words: ['map', 'cap', 'tap', 'nap'] },
            'ag': { emoji: 'ğŸ›ï¸', words: ['bag', 'rag', 'tag', 'wag'] }
        },
        'e': {
            'et': { emoji: 'ğŸš€', words: ['jet', 'net', 'pet', 'wet', 'vet'] },
            'en': { emoji: 'ğŸ”', words: ['hen', 'ten', 'pen', 'men', 'den'] },
            'ed': { emoji: 'ğŸ›ï¸', words: ['bed', 'red', 'wed', 'fed'] }
        },
        'i': {
            'ig': { emoji: 'ğŸ·', words: ['pig', 'wig', 'big', 'dig', 'fig'] },
            'in': { emoji: 'ğŸ—‘ï¸', words: ['bin', 'pin', 'fin', 'win', 'tin'] },
            'ip': { emoji: 'ğŸ‘„', words: ['lip', 'zip', 'tip', 'hip', 'dip'] },
            'it': { emoji: 'ğŸ§˜', words: ['sit', 'hit', 'kit', 'fit', 'bit'] }
        },
        'o': {
            'og': { emoji: 'ğŸ¶', words: ['dog', 'log', 'jog', 'hog'] },
            'op': { emoji: 'ğŸ§¹', words: ['mop', 'top', 'hop', 'pop', 'cop'] },
            'ot': { emoji: 'ğŸ²', words: ['pot', 'hot', 'dot', 'cot'] },
            'ox': { emoji: 'ğŸ“¦', words: ['box', 'fox'] }
        },
        'u': {
            'ug': { emoji: 'ğŸ', words: ['bug', 'hug', 'jug', 'mug', 'rug'] },
            'un': { emoji: 'â˜€ï¸', words: ['sun', 'run', 'bun', 'nun'] },
            'ut': { emoji: 'ğŸ¥œ', words: ['nut', 'cut', 'hut'] },
            'ub': { emoji: 'ğŸ›€', words: ['tub', 'cub', 'sub', 'rub'] }
        }
    };

    let currentVowel = '', currentFamily = '', currentTarget = '', score = 0;
    
    // éŒ„éŸ³ç›¸é—œè®Šæ•¸
    let mediaRecorder = null;
    let audioChunks = [];
    let audioUrl = null;
    let isRecording = false;

    // ----- 3. éŠæˆ²é‚è¼¯ -----
    function showFamilies(v) {
        currentVowel = v;
        document.getElementById('view-vowels').classList.add('hidden');
        document.getElementById('view-families').classList.remove('hidden');
        document.getElementById('family-title').innerText = `Short ${v} Families`;
        const list = document.getElementById('family-list');
        list.innerHTML = '';
        Object.keys(cvcData[v]).forEach(f => {
            const btn = document.createElement('button');
            btn.className = 'btn-family'; btn.innerText = `-${f}`;
            btn.onclick = () => startGame(f);
            list.appendChild(btn);
        });
    }

    function startGame(f) {
        currentFamily = f; score = 0;
        document.getElementById('view-families').classList.add('hidden');
        document.getElementById('view-game').classList.remove('hidden');
        // åœ¨é€²å…¥éŠæˆ²æ™‚é å…ˆåˆå§‹åŒ–éŒ„éŸ³å™¨ï¼Œç¢ºä¿æ¬Šé™
        initRecorder();
        nextRound();
    }

    function nextRound() {
        stopVictoryMusic();
        document.getElementById('question-area').classList.remove('hidden');
        document.getElementById('feedback-area').classList.add('hidden');
        document.getElementById('playRecBtn').classList.add('hidden');
        document.getElementById('star-display').classList.remove('victory-jump');
        
        const data = cvcData[currentVowel][currentFamily];
        currentTarget = data.words[Math.floor(Math.random() * data.words.length)];
        document.getElementById('word-emoji').innerText = data.emoji;
        document.getElementById('game-title').innerText = `-${currentFamily} Family`;

        const distractor = "sun"; 
        const options = [currentTarget, distractor].sort(() => Math.random() - 0.5);
        document.getElementById('opt1').innerText = options[0];
        document.getElementById('opt2').innerText = options[1];
        updateStars();
        speak(currentTarget);
    }

    function speak(t) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t);
        m.lang = 'en-US'; m.rate = 0.8;
        window.speechSynthesis.speak(m);
    }

    function checkAnswer(el) {
        stopVictoryMusic();
        if (el.innerText === currentTarget) {
            score++; updateStars();
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('feedback-area').classList.remove('hidden');
            if (score > 0 && score % 5 === 0) {
                victoryAudio.play();
                document.getElementById('star-display').classList.add('victory-jump');
            }
        } else { speak("Try again"); }
    }

    function updateStars() {
        let s = score % 5 === 0 && score !== 0 ? 5 : score % 5;
        document.getElementById('star-display').innerText = "â˜…".repeat(s) + "â˜†".repeat(5 - s);
    }

    // ----- 4. iOS éŒ„éŸ³å„ªåŒ–æ ¸å¿ƒ (é—œéµä¿®æ­£) -----
    
    async function initRecorder() {
        // å¦‚æœå·²ç¶“æœ‰ recorder å°±ä¸é‡è¤‡åˆå§‹åŒ–
        if (mediaRecorder) return;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // åµæ¸¬æ”¯æ´çš„æ ¼å¼ï¼šå„ªå…ˆé¸æ“‡ mp4 (iOS 14.8+ æ”¯æ´)ï¼Œå¦å‰‡ç”¨ webm (Android/Chrome)
            let mimeType = 'audio/webm';
            if (MediaRecorder.isTypeSupported('audio/mp4')) {
                mimeType = 'audio/mp4';
            }
            
            console.log("Using recording format:", mimeType);

            mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                // åœæ­¢æ™‚ï¼Œä½¿ç”¨æ­£ç¢ºçš„ MIME Type å»ºç«‹æª”æ¡ˆï¼Œé€™æ¨£ iOS æ‰æ’­å¾—å‡ºè²éŸ³
                const blob = new Blob(audioChunks, { type: mimeType });
                audioUrl = URL.createObjectURL(blob);
                document.getElementById('playRecBtn').classList.remove('hidden');
            };

        } catch (err) {
            console.error("Microphone access error:", err);
            // åªæœ‰åœ¨çœŸçš„éœ€è¦éŒ„éŸ³æ™‚æ‰å ±éŒ¯ï¼Œé¿å…ä¸€é–‹å§‹å°±åš‡åˆ°ä½¿ç”¨è€…
        }
    }

    async function toggleRecording() {
        // ç¢ºä¿éŒ„éŸ³å™¨å·²æº–å‚™å¥½
        if (!mediaRecorder) {
            await initRecorder();
        }

        if (!mediaRecorder) {
            alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ã€‚è«‹ç¢ºèªï¼š\n1. ä½¿ç”¨ Safari é–‹å•Ÿ\n2. ç¶²å€æ˜¯ HTTPS é–‹é ­");
            return;
        }

        if (!isRecording && mediaRecorder.state === "inactive") {
            // é–‹å§‹éŒ„éŸ³
            audioChunks = []; 
            mediaRecorder.start(); 
            isRecording = true;
            document.getElementById('recBtn').innerText = "â¹ï¸";
            document.getElementById('rec-hint').innerText = "éŒ„éŸ³ä¸­...";
        } else if (isRecording && mediaRecorder.state === "recording") {
            // åœæ­¢éŒ„éŸ³
            mediaRecorder.stop(); 
            isRecording = false;
            document.getElementById('recBtn').innerText = "ğŸ¤";
            document.getElementById('rec-hint').innerText = "é»ä¸€ä¸‹éŒ„éŸ³";
        }
    }

    function playBack() { 
        if(audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play().catch(e => {
                alert("æ’­æ”¾å¤±æ•—ï¼Œè«‹ç¢ºèªæ‚¨çš„è£ç½®æœªé–‹å•ŸéœéŸ³æ¨¡å¼ã€‚");
                console.error(e);
            });
        }
    }

</script>
</body>
</html>
